var w=Object.defineProperty;var O=(t,e,s)=>e in t?w(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var A=(t,e,s)=>O(t,typeof e!="symbol"?e+"":e,s);import{o as f,n as r,h as m,i as V,j as E,s as c,b as G,g as R,k as _,m as q,p as U,e as J,d as B}from"./loaders-Bj0CnEmo.js";class j{constructor(){A(this,"listeners",{})}on(e,s){return this.listeners[e]=this.listeners[e]||[],this.listeners[e].push(s),()=>this.off(e,s)}off(e,s){this.listeners[e]=(this.listeners[e]||[]).filter(a=>a!==s)}emit(e){const s={timestamp:Date.now(),...e};(this.listeners[e.type]||[]).forEach(o=>o(s)),(this.listeners["*"]||[]).forEach(o=>o(s))}}const y=new j;function D(t){y.emit(t)}function F(t,e){return t==="*"?y.on("*",e):y.on(t,e)}const d=3,X="nintendo-hub-save",z=f({saveSchemaVersion:r().int().default(1),state:m(V()).default({}),lastPlayedAt:r().optional(),bestScore:r().optional(),timePlayedMs:r().default(0),sessionStartedAt:r().optional()}),k=f({schemaVersion:r().int().default(d),playerProfile:f({name:c(),avatar:c(),lastPlayedGameId:c().optional()}).default({name:"Joueur",avatar:"ðŸŽ®"}),globalXP:r().default(0),globalLevel:r().default(1),achievementsUnlocked:E(c()).default([]),globalStats:f({events:m(r()).default({}),gamesPlayed:r().default(0),totalSessions:r().default(0),streaks:m(r()).default({}),timePlayedMs:r().default(0),currentSessionStartedAt:r().optional()}).default({events:{},gamesPlayed:0,totalSessions:0,streaks:{},timePlayedMs:0}),favorites:E(c()).default([]),games:m(z).default({})});function p(){return{schemaVersion:d,playerProfile:{name:"Joueur",avatar:"ðŸŽ®"},globalXP:0,globalLevel:1,achievementsUnlocked:[],globalStats:{events:{},gamesPlayed:0,totalSessions:0,streaks:{},timePlayedMs:0},favorites:[],games:{}}}function I(t){let e={...t};return(!e.schemaVersion||e.schemaVersion<1)&&(e.schemaVersion=1),e.schemaVersion<2&&(e.globalStats.timePlayedMs=e.globalStats.timePlayedMs??0,e.globalStats.currentSessionStartedAt=void 0,Object.values(e.games||{}).forEach(s=>{s.timePlayedMs=s.timePlayedMs??0,s.sessionStartedAt=void 0}),e.schemaVersion=2),e.schemaVersion<3&&(e.favorites=Array.isArray(e.favorites)?Array.from(new Set(e.favorites.filter(s=>typeof s=="string"))):[],e.schemaVersion=3),e.schemaVersion<d&&(e.schemaVersion=d),e}function h(){try{const t=localStorage.getItem(X);if(!t)return p();const e=JSON.parse(t),s=k.parse(e);return I(s)}catch(t){return console.warn("Corrupt save detected, resetting.",t),p()}}function S(t){const e={...t,schemaVersion:d};localStorage.setItem(X,JSON.stringify(e))}function P(t){const e=h();return t(e),S(e),e}function se(){const t=h();return JSON.stringify(t,null,2)}function ae(t){try{const e=JSON.parse(t),s=k.parse(e),a=I(s);return S(a),{success:!0,state:a}}catch(e){return{success:!1,error:(e==null?void 0:e.message)||"Import invalide"}}}function ne(){const t=p();return S(t),t}function oe(t){return P(e=>{delete e.games[t]})}function v(t,e,s=1){return t.games[e]||(t.games[e]={saveSchemaVersion:s,state:{},timePlayedMs:0}),t.games[e]}function M(t,e){t.playerProfile.lastPlayedGameId=e;const s=v(t,e);s.lastPlayedAt=Date.now()}function re(t,e,s){return P(a=>{const n=v(a,t,e);n.saveSchemaVersion=e,s(n),M(a,t)})}const l={xpConfig:U(),rewardsConfig:q(),achievements:_(),registry:R(),gameConfigs:G()},g={achievementId:"alex-birthday-31",minXP:31e3,requiredName:"alex"};function H(t){return l.gameConfigs.find(e=>e.id===t)||B(t)}function K(t){var s;const e=t.gameId?H(t.gameId):void 0;return((s=e==null?void 0:e.xpRules)==null?void 0:s[t.type])!==void 0?e.xpRules[t.type]:l.rewardsConfig.defaults[t.type]??0}function x(t,e){var b;const s=[...e.levels].sort((i,T)=>i.requiredXP-T.requiredXP);let a=1,n=s[s.length-1].requiredXP;for(let i=0;i<s.length;i++)t>=s[i].requiredXP&&(a=s[i].level,n=s[Math.min(s.length-1,i+1)].requiredXP);const o=((b=s.find(i=>i.level===a))==null?void 0:b.requiredXP)??0,u=Math.max(n-o,1),L=J((t-o)/u,0,1);return{level:a,nextLevelXP:n,currentLevelXP:o,levelProgress:L}}function W(t,e){var n;const s=e.condition,a=(n=t.playerProfile.name)==null?void 0:n.trim().toLowerCase();return s.type==="eventCount"?(t.globalStats.events[s.event]??0)>=s.count:s.type==="xpReached"?t.globalXP>=s.xp:s.type==="gamesPlayed"?Object.keys(t.games).length>=s.count:s.type==="streak"?(t.globalStats.streaks[s.event]??0)>=s.count:s.type==="playerXpName"?t.globalXP>=s.xp&&a===s.name.trim().toLowerCase():!1}function N(t,e){e.forEach(s=>{if(t.achievementsUnlocked.includes(s.id))return;W(t,s)&&(t.achievementsUnlocked.push(s.id),s.rewardXP&&(t.globalXP+=s.rewardXP),D({type:"ACHIEVEMENT_UNLOCKED",payload:{achievementId:s.id}}))})}function ie(t){var a;const e=(a=t.playerProfile.name)==null?void 0:a.trim().toLowerCase();return t.achievementsUnlocked.includes(g.achievementId)&&t.globalXP>=g.minXP&&e===g.requiredName}function Y(t,e){t.globalStats.streaks[e.type]||(t.globalStats.streaks[e.type]=0),t.globalStats.streaks[e.type]+=1,e.type==="SESSION_FAIL"&&(t.globalStats.streaks.SESSION_WIN=0)}function Q(t,e,s){const a=e.timestamp??Date.now();if(e.type==="SESSION_START"){if(t.globalStats.currentSessionStartedAt=a,s){if(s.sessionStartedAt&&s.sessionStartedAt<a){const n=a-s.sessionStartedAt;s.timePlayedMs=(s.timePlayedMs??0)+Math.max(0,n),t.globalStats.timePlayedMs=(t.globalStats.timePlayedMs??0)+Math.max(0,n)}s.sessionStartedAt=a}return}if(e.type==="SESSION_WIN"||e.type==="SESSION_FAIL"){const n=(s==null?void 0:s.sessionStartedAt)??t.globalStats.currentSessionStartedAt,o=n?Math.max(0,a-n):0;t.globalStats.timePlayedMs=(t.globalStats.timePlayedMs??0)+o,s&&(s.timePlayedMs=(s.timePlayedMs??0)+o,s.sessionStartedAt=void 0),t.globalStats.currentSessionStartedAt=void 0}}function Z(t,e){var a;const s=K(e);if(s>0&&(t.globalXP+=s),t.globalStats.events[e.type]||(t.globalStats.events[e.type]=0),t.globalStats.events[e.type]+=1,t.globalStats.totalSessions+=e.type==="SESSION_START"?1:0,Y(t,e),e.gameId){const n=!!t.games[e.gameId],o=v(t,e.gameId);if(Q(t,e,o),e.type==="SESSION_START"&&(t.globalStats.gamesPlayed+=n?0:1),M(t,e.gameId),((a=e.payload)==null?void 0:a.score)!==void 0){const u=Number(e.payload.score);(!o.bestScore||u>o.bestScore)&&(o.bestScore=u)}}}function C(t){const{level:e}=x(t.globalXP,l.xpConfig);t.globalLevel=e}function $(t){return P(s=>{Z(s,t),N(s,l.achievements),C(s)})}function le(){F("*",t=>{$(t)})}function ce(){const t=h();N(t,l.achievements),C(t);const{levelProgress:e,currentLevelXP:s,nextLevelXP:a}=x(t.globalXP,l.xpConfig),n={save:t,levelProgress:e,currentLevelXP:s,nextLevelXP:a};return S(t),n}export{g as A,le as a,ne as b,ie as c,D as d,se as e,re as f,ce as g,ae as i,h as l,F as o,oe as r,P as u};
