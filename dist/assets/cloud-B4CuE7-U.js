let a=null,e={ready:!!a,user:null};const u=[];function t(){u.forEach(s=>s(e))}function f(s){return u.push(s),()=>{const r=u.indexOf(s);r>=0&&u.splice(r,1)}}function l(){return e={ready:!1,user:null,error:"Supabase non configuré."},t(),!1}function v(){return e}async function y(s,r){var g;if(!l())return e;if(s==="logout")return e={...e,loading:!0,error:void 0},t(),await a.auth.signOut(),e={ready:!0,user:null,session:null,message:"Déconnecté"},t(),e;const i=(g=r==null?void 0:r.email)==null?void 0:g.trim(),d=(r==null?void 0:r.password)||"";if(!i||d.length<6)return e={...e,error:"Email/mot de passe invalide."},t(),e;e={...e,loading:!0,error:void 0,message:void 0},t();const c=a.auth;try{if(s==="login"){const{data:n,error:o}=await c.signInWithPassword({email:i,password:d});if(o)throw o;e={ready:!0,user:n.user,session:n.session,message:"Connecté"}}else if(s==="register"){const{data:n,error:o}=await c.signUp({email:i,password:d});if(o)throw o;e={ready:!0,user:n.user,session:n.session,message:"Compte créé (pense à vérifier ton email)."}}}catch(n){e={...e,error:(n==null?void 0:n.message)||"Erreur d'auth Supabase"}}return e={...e,loading:!1},t(),e}async function h(s){if(!l())return!1;if(!e.user)return e={...e,error:"Connecte-toi pour synchroniser."},t(),!1;e={...e,loading:!0,error:void 0,message:void 0},t();const{error:r}=await a.from("saves").upsert({user_id:e.user.id,save:s,updated_at:new Date().toISOString()});return e={...e,loading:!1,lastSyncedAt:Date.now(),message:r?void 0:"Sauvegarde envoyée.",error:r==null?void 0:r.message},t(),!r}async function m(){if(!l())return{error:"Supabase non configuré."};if(!e.user)return{error:"Connecte-toi pour charger."};e={...e,loading:!0,error:void 0,message:void 0},t();const{data:s,error:r}=await a.from("saves").select("save, updated_at").eq("user_id",e.user.id).maybeSingle();return e={...e,loading:!1,lastSyncedAt:s?Date.now():e.lastSyncedAt,message:r?void 0:s?"Sauvegarde cloud récupérée.":e.message,error:r==null?void 0:r.message},t(),r?{error:r.message}:s?{state:s.save}:{error:"Aucune sauvegarde trouvée."}}export{f as a,y as c,v as g,m as l,h as s};
