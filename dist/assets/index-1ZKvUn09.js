var T=Object.defineProperty;var G=(e,t,s)=>t in e?T(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var b=(e,t,s)=>G(e,typeof t!="symbol"?t+"":t,s);import{o as f,n as r,h as d,i as O,j as w,s as u,b as A,g as R,k as V,l as _,m as q,e as J,d as U}from"./loaders-BqXlQhzP.js";class B{constructor(){b(this,"listeners",{})}on(t,s){return this.listeners[t]=this.listeners[t]||[],this.listeners[t].push(s),()=>this.off(t,s)}off(t,s){this.listeners[t]=(this.listeners[t]||[]).filter(a=>a!==s)}emit(t){const s={timestamp:Date.now(),...t};(this.listeners[t.type]||[]).forEach(o=>o(s)),(this.listeners["*"]||[]).forEach(o=>o(s))}}const m=new B;function M(e){m.emit(e)}function j(e,t){return e==="*"?m.on("*",t):m.on(e,t)}const S=1,E="nintendo-hub-save",D=f({saveSchemaVersion:r().int().default(1),state:d(O()).default({}),lastPlayedAt:r().optional(),bestScore:r().optional()}),X=f({schemaVersion:r().int().default(S),playerProfile:f({name:u(),avatar:u(),lastPlayedGameId:u().optional()}).default({name:"Joueur",avatar:"ðŸŽ®"}),globalXP:r().default(0),globalLevel:r().default(1),achievementsUnlocked:w(u()).default([]),globalStats:f({events:d(r()).default({}),gamesPlayed:r().default(0),totalSessions:r().default(0),streaks:d(r()).default({})}).default({events:{},gamesPlayed:0,totalSessions:0,streaks:{}}),games:d(D).default({})});function p(){return{schemaVersion:S,playerProfile:{name:"Joueur",avatar:"ðŸŽ®"},globalXP:0,globalLevel:1,achievementsUnlocked:[],globalStats:{events:{},gamesPlayed:0,totalSessions:0,streaks:{}},games:{}}}function k(e){let t={...e};return(!t.schemaVersion||t.schemaVersion<1)&&(t.schemaVersion=1),t}function y(){try{const e=localStorage.getItem(E);if(!e)return p();const t=JSON.parse(e),s=X.parse(t);return k(s)}catch(e){return console.warn("Corrupt save detected, resetting.",e),p()}}function g(e){const t={...e,schemaVersion:S};localStorage.setItem(E,JSON.stringify(t))}function h(e){const t=y();return e(t),g(t),t}function $(){const e=y();return JSON.stringify(e,null,2)}function ee(e){try{const t=JSON.parse(e),s=X.parse(t),a=k(s);return g(a),{success:!0,state:a}}catch(t){return{success:!1,error:(t==null?void 0:t.message)||"Import invalide"}}}function te(){const e=p();return g(e),e}function se(e){return h(t=>{delete t.games[e]})}function v(e,t,s=1){return e.games[t]||(e.games[t]={saveSchemaVersion:s,state:{}}),e.games[t]}function C(e,t){e.playerProfile.lastPlayedGameId=t;const s=v(e,t);s.lastPlayedAt=Date.now()}function ae(e,t,s){return h(a=>{const n=v(a,e,t);n.saveSchemaVersion=t,s(n),C(a,e)})}const c={xpConfig:q(),rewardsConfig:_(),achievements:V(),registry:R(),gameConfigs:A()};function F(e){return c.gameConfigs.find(t=>t.id===e)||U(e)}function H(e){var s;const t=e.gameId?F(e.gameId):void 0;return((s=t==null?void 0:t.xpRules)==null?void 0:s[e.type])!==void 0?t.xpRules[e.type]:c.rewardsConfig.defaults[e.type]??0}function I(e,t){var P;const s=[...t.levels].sort((l,N)=>l.requiredXP-N.requiredXP);let a=1,n=s[s.length-1].requiredXP;for(let l=0;l<s.length;l++)e>=s[l].requiredXP&&(a=s[l].level,n=s[Math.min(s.length-1,l+1)].requiredXP);const o=((P=s.find(l=>l.level===a))==null?void 0:P.requiredXP)??0,i=Math.max(n-o,1),L=J((e-o)/i,0,1);return{level:a,nextLevelXP:n,currentLevelXP:o,levelProgress:L}}function K(e,t,s){s.forEach(a=>{if(e.achievementsUnlocked.includes(a.id))return;const n=a.condition;let o=!1;n.type==="eventCount"?o=(e.globalStats.events[n.event]??0)>=n.count:n.type==="xpReached"?o=e.globalXP>=n.xp:n.type==="gamesPlayed"?o=Object.keys(e.games).length>=n.count:n.type==="streak"&&(o=(e.globalStats.streaks[n.event]??0)>=n.count),o&&(e.achievementsUnlocked.push(a.id),a.rewardXP&&(e.globalXP+=a.rewardXP),M({type:"ACHIEVEMENT_UNLOCKED",payload:{achievementId:a.id}}))})}function W(e,t){e.globalStats.streaks[t.type]||(e.globalStats.streaks[t.type]=0),e.globalStats.streaks[t.type]+=1,t.type==="SESSION_FAIL"&&(e.globalStats.streaks.SESSION_WIN=0)}function Y(e,t){var a;const s=H(t);if(s>0&&(e.globalXP+=s),e.globalStats.events[t.type]||(e.globalStats.events[t.type]=0),e.globalStats.events[t.type]+=1,e.globalStats.totalSessions+=t.type==="SESSION_START"?1:0,W(e,t),t.gameId){const n=!!e.games[t.gameId],o=v(e,t.gameId);if(t.type==="SESSION_START"&&(e.globalStats.gamesPlayed+=n?0:1),C(e,t.gameId),((a=t.payload)==null?void 0:a.score)!==void 0){const i=Number(t.payload.score);(!o.bestScore||i>o.bestScore)&&(o.bestScore=i)}}}function x(e){const{level:t}=I(e.globalXP,c.xpConfig);e.globalLevel=t}function z(e){return h(s=>{Y(s,e),K(s,e,c.achievements),x(s)})}function ne(){j("*",e=>{z(e)})}function oe(){const e=y();x(e);const{levelProgress:t,currentLevelXP:s,nextLevelXP:a}=I(e.globalXP,c.xpConfig),n={save:e,levelProgress:t,currentLevelXP:s,nextLevelXP:a};return g(e),n}export{$ as a,ne as b,se as c,ae as d,M as e,oe as g,ee as i,j as o,te as r,h as u};
